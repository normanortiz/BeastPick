<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Beast Pick - Voting</title>

    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json">

    <!-- Icons -->
    <link rel="icon" type="image/x-icon" href="/images/favicon.ico">
    <link rel="icon" type="image/svg+xml" href="/images/favicon.svg">
    <link rel="icon" type="image/png" sizes="96x96" href="/images/favicon-96x96.png">
    <link rel="apple-touch-icon" href="/images/app-icon.png">

    <!-- iOS Web App Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="BeastPick">

    <!-- Theme Color -->
    <meta name="theme-color" content="#000000">

    <link rel="stylesheet" href="/css/global.css?v=11">
    <link rel="stylesheet" href="/css/contestant.css?v=11">
</head>
<body>
    <!-- Logout Confirmation Modal -->
    <div class="logout-modal" id="logoutModal" style="display: none;">
        <div class="modal-content">
            <h2>LOGOUT</h2>
            <p>Are you sure you want to logout?</p>
            <div class="modal-buttons">
                <button class="btn btn-secondary" id="cancelLogoutBtn">CANCEL</button>
                <button class="btn btn-primary" id="confirmLogoutBtn">LOGOUT</button>
            </div>
        </div>
    </div>

    <!-- Header -->
    <header class="contestant-header">
        <div class="header-image" id="headerImage">
            <img src="/images/BeastPick.png" alt="Beast Pick Logo">
        </div>
        <button class="lock-btn" id="logoutBtn">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <rect x="5" y="11" width="14" height="10" rx="2" stroke="white" stroke-width="2" opacity="0.6"/>
                <path d="M8 11V7a4 4 0 0 1 8 0v4" stroke="white" stroke-width="2" stroke-linecap="round" opacity="0.6"/>
                <circle cx="12" cy="16" r="1.5" fill="white" opacity="0.6"/>
            </svg>
        </button>
    </header>

    <!-- Main Content -->
    <main class="contestant-main">
        <!-- Timer Display -->
        <div class="timer-container" id="timerContainer">
            <div class="timer-display" id="timerDisplay">0:00</div>
        </div>

        <h1 class="voting-title">CAST YOUR VOTE</h1>

        <!-- Vote Value Controls (for Quantity & Player mode) -->
        <div class="vote-controls" id="voteControls">
            <button class="vote-btn vote-minus" id="decreaseBtn">-</button>
            <div class="vote-value">
                <span id="voteValue">15</span>
                <span class="vote-unit" id="voteUnit">lbs</span>
            </div>
            <button class="vote-btn vote-plus" id="increaseBtn">+</button>
        </div>

        <!-- Option Buttons (for Option & Player mode) -->
        <div class="option-buttons" id="optionButtons" style="display: none;">
            <button class="option-btn" id="optionABtn">OPTION A</button>
            <button class="option-btn" id="optionBBtn">OPTION B</button>
        </div>

        <!-- Players Grid -->
        <div class="players-grid" id="playersGrid">
            <!-- Player cards will be dynamically inserted here -->
        </div>
    </main>

    <script src="/js/auth.js"></script>
    <script src="/js/data.js"></script>
    <script src="/js/contestant.js?v=10"></script>
    <script>
        console.log('=== VOTING.HTML SCRIPT LOADED ===');

        // Check authentication (bypassed for development)
        // if (!checkAuthentication('contestant')) {
        //     // Will redirect if not authenticated
        // }

        // Logout button handler
        document.getElementById('logoutBtn').addEventListener('click', () => {
            document.getElementById('logoutModal').style.display = 'flex';
        });

        document.getElementById('cancelLogoutBtn').addEventListener('click', () => {
            document.getElementById('logoutModal').style.display = 'none';
        });

        document.getElementById('confirmLogoutBtn').addEventListener('click', () => {
            sessionStorage.clear();
            window.location.href = '/players.html';
        });

        // Timer functionality
        let timerInterval;
        let timerEndTime = 0; // Timestamp when timer should end
        let isTimerActive = false;

        async function initTimer() {
            try {
                const config = await getGameConfig();

                console.log('Timer init - Visibility:', config.timerVisibility, 'Duration:', config.timerDuration, 'Locked:', config.votingLocked, 'StartTime:', config.timerStartTime);

                // ALWAYS SHOW TIMER - NO CONDITIONS
                document.getElementById('timerContainer').style.display = 'block';

                // Calculate end time based on when admin started the timer
                const duration = config.timerDuration || 60;

                // If admin has set a start time, use it to synchronize all clients
                if (config.timerStartTime && !config.votingLocked) {
                    timerEndTime = config.timerStartTime + (duration * 1000);
                    console.log('Timer synced to admin start time:', new Date(config.timerStartTime), 'ending at', new Date(timerEndTime));
                } else {
                    // Fallback: use current time (shouldn't happen in normal flow)
                    timerEndTime = Date.now() + (duration * 1000);
                    console.log('Timer using local time, ending at', new Date(timerEndTime));
                }

                isTimerActive = true;
                startTimer();
            } catch (error) {
                console.error('Error initializing timer:', error);
                // FORCE DISPLAY EVEN ON ERROR
                document.getElementById('timerContainer').style.display = 'block';
                timerEndTime = Date.now() + (60 * 1000);
                isTimerActive = true;
                startTimer();
            }
        }

        function startTimer() {
            updateTimerDisplay();

            timerInterval = setInterval(async () => {
                const now = Date.now();
                const timeRemaining = Math.max(0, Math.ceil((timerEndTime - now) / 1000));

                if (timeRemaining > 0) {
                    updateTimerDisplay();
                } else {
                    // Timer reached 0:00
                    clearInterval(timerInterval);
                    lockVoting();

                    // Ensure voting is locked in Firebase (admin will also do this)
                    try {
                        await updateGameConfig({ votingLocked: true });
                    } catch (error) {
                        console.error('Error updating voting lock:', error);
                    }
                }
            }, 100); // Check every 100ms for smooth countdown
        }

        function updateTimerDisplay() {
            const now = Date.now();
            const timeRemaining = Math.max(0, Math.ceil((timerEndTime - now) / 1000));

            const minutes = Math.floor(timeRemaining / 60);
            const seconds = timeRemaining % 60;
            const display = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            const timerElement = document.getElementById('timerDisplay');
            timerElement.textContent = display;

            // Add critical class for last 5 seconds
            if (timeRemaining <= 5 && timeRemaining > 0) {
                timerElement.classList.add('critical');
            } else {
                timerElement.classList.remove('critical');
            }
        }

        function lockVoting() {
            // DON'T show lock overlay - just lock the cards
            // document.getElementById('lockOverlay').style.display = 'flex';

            // Lock all player cards
            document.querySelectorAll('.player-card').forEach(card => {
                card.classList.add('locked');
            });

            // Lock vote buttons
            document.querySelectorAll('.vote-btn').forEach(btn => {
                btn.classList.add('locked');
            });

            // Lock option buttons
            document.querySelectorAll('.option-btn').forEach(btn => {
                btn.classList.add('locked');
            });
        }

        function unlockVoting() {
            // Hide lock overlay
            document.getElementById('lockOverlay').style.display = 'none';

            // Unlock all player cards
            document.querySelectorAll('.player-card').forEach(card => {
                card.classList.remove('locked');
            });

            // Unlock vote buttons
            document.querySelectorAll('.vote-btn').forEach(btn => {
                btn.classList.remove('locked');
            });

            // Unlock option buttons
            document.querySelectorAll('.option-btn').forEach(btn => {
                btn.classList.remove('locked');
            });
        }

        // Listen for voting lock state changes
        async function watchVotingLockState() {
            try {
                console.log('watchVotingLockState called');
                // Initial check
                const config = await getGameConfig();
                console.log('Got config:', config);
                let previousLockState = config.votingLocked !== undefined ? config.votingLocked : true;
                console.log('Previous lock state:', previousLockState);

                if (previousLockState) {
                    console.log('Locking voting (initial)');
                    lockVoting();
                    initTimer();
                } else {
                    console.log('Unlocking voting and initializing timer (initial)');
                    unlockVoting();
                    initTimer();
                }

                // Poll for changes every 500ms for fast response
                setInterval(async () => {
                    const updatedConfig = await getGameConfig();
                    const isLocked = updatedConfig.votingLocked !== undefined ? updatedConfig.votingLocked : true;

                    // If voting just unlocked (went from locked to unlocked), restart timer immediately
                    if (previousLockState && !isLocked) {
                        console.log('Voting unlocked, restarting timer...');
                        unlockVoting();
                        // Stop any existing timer
                        if (timerInterval) {
                            clearInterval(timerInterval);
                        }
                        // Restart timer with fresh duration
                        await initTimer();
                        previousLockState = isLocked;
                        return;
                    }

                    previousLockState = isLocked;

                    if (isLocked) {
                        lockVoting();
                    } else {
                        unlockVoting();
                    }
                }, 500);
            } catch (error) {
                console.error('Error watching voting lock state:', error);
            }
        }

        // Initialize voting lock state watcher when page loads
        console.log('About to call watchVotingLockState()...');
        watchVotingLockState();
    </script>
</body>
</html>
