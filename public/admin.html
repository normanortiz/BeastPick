<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Beast Pick - Admin Panel</title>
    <link rel="icon" type="image/x-icon" href="/images/favicon.ico">
    <link rel="icon" type="image/svg+xml" href="/images/favicon.svg">
    <link rel="icon" type="image/png" sizes="96x96" href="/images/favicon-96x96.png">
    <link rel="apple-touch-icon" href="/images/apple-touch-icon.png">
    <link rel="stylesheet" href="/css/global.css">
    <style>
        body {
            background: #000;
            color: #fff;
            padding: 0;
            margin: 0;
        }

        .admin-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 30px;
        }

        .admin-header {
            position: relative;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .admin-header h1 {
            font-size: 48px;
            font-weight: 800;
            background: linear-gradient(135deg, var(--primary-blue), var(--primary-pink));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .admin-logo {
            max-width: 200px;
            height: auto;
        }

        .lock-btn {
            background: transparent;
            border: none;
            cursor: pointer;
            padding: 10px;
            transition: transform 0.3s ease;
        }

        .lock-btn:hover {
            transform: scale(1.1);
        }

        .lock-btn:active {
            transform: scale(0.95);
        }

        .tabs {
            display: flex;
            gap: 40px;
            flex-wrap: wrap;
        }

        .tab {
            padding: 15px 0;
            font-family: var(--font-family);
            font-size: 20px;
            font-weight: 800;
            background: transparent;
            border: none;
            color: var(--gray);
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            border-bottom: 3px solid transparent;
        }

        .tab.active {
            color: var(--primary-blue);
            border-bottom-color: var(--primary-blue);
        }

        .tab:hover {
            color: var(--white);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .section {
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
        }

        .logo-preview-clickable {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 150px;
            margin-top: 10px;
            background: rgba(0, 0, 0, 0.5);
            border: 2px dashed var(--primary-blue);
            border-radius: 12px;
            padding: 0 20px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .logo-preview-clickable:hover {
            border-color: var(--primary-pink);
            background: rgba(0, 0, 0, 0.7);
        }

        .logo-preview-clickable img {
            max-width: 100%;
            max-height: 150px;
            object-fit: contain;
        }

        .logo-preview-placeholder {
            color: rgba(255, 255, 255, 0.5);
            font-size: 16px;
            text-align: center;
        }

        .settings-grid {
            display: grid;
            grid-template-columns: 45% 10% 45%;
            gap: 0;
            padding-top: 60px;
        }

        .control-panel {
            padding-top: 60px;
        }

        .settings-column {
            display: flex;
            flex-direction: column;
            gap: 40px;
        }

        .form-group {
            margin-bottom: 0;
        }

        .form-group label,
        .field-label {
            font-size: 16px;
            font-weight: 800;
            color: var(--white);
            text-transform: uppercase;
        }

        .input-with-toggle {
            display: flex;
            align-items: center;
            gap: 0px;
            flex-wrap: wrap;
        }

        .input-with-toggle .field-label {
            width: 100%;
            margin-bottom: 0;
            transition: all 0.3s ease;
        }

        .input-with-toggle input[type="number"],
        .input-with-toggle input[type="text"],
        .input-with-toggle input[type="tel"] {
            transition: all 0.3s ease;
            flex: 1;
            margin-right: 30px;
        }

        .input-with-toggle input.hidden {
            display: none;
        }

        .input-with-toggle.no-input {
            flex-wrap: nowrap;
            justify-content: space-between;
        }

        .input-with-toggle.no-input .field-label {
            width: auto;
            flex: 0;
        }

        .input-with-toggle.no-input .toggle-switch {
            flex: 0;
        }

        .input-with-toggle input,
        .form-group .combobox-container {
            flex: 1;
            width: 100%;
            margin-top: 10px;
        }

        .input-with-toggle input,
        .form-group input {
            margin-top: 10px;
            padding: 15px;
            font-family: var(--font-family);
            font-size: 18px;
            background: rgba(0, 0, 0, 0.5);
            border: 2px solid var(--primary-blue);
            border-radius: 12px;
            color: var(--white);
            width: 100%;
            box-sizing: border-box;
            transition: border-color 0.3s ease;
        }

        .input-with-toggle input:hover,
        .form-group input:hover,
        .input-with-toggle input:focus,
        .form-group input:focus {
            outline: none;
            border-color: var(--primary-pink);
        }

        .file-input-wrapper {
            margin-top: 10px;
            padding: 15px;
            font-family: var(--font-family);
            font-size: 18px;
            background: rgba(0, 0, 0, 0.5);
            border: 2px solid var(--primary-blue);
            border-radius: 12px;
            color: var(--white);
            width: 100%;
            box-sizing: border-box;
            transition: border-color 0.3s ease;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .file-input-wrapper:hover {
            border-color: var(--primary-pink);
        }

        .file-browse-btn {
            background: var(--primary-blue);
            color: var(--white);
            border: none;
            padding: 8px 20px;
            border-radius: 8px;
            font-family: var(--font-family);
            font-weight: 800;
            font-size: 14px;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .file-browse-btn:hover {
            background: var(--primary-pink);
        }

        .password-input-wrapper {
            position: relative;
            width: 100%;
        }

        .password-input-wrapper,
        .input-with-label {
            position: relative;
            width: 100%;
        }

        .password-toggle {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: var(--primary-blue);
            cursor: pointer;
            font-family: var(--font-family);
            font-size: 14px;
            font-weight: 400;
            transition: color 0.3s ease;
            padding: 0;
            padding-top: 5px;
            margin: 0;
            line-height: 1;
            height: 14px;
        }

        .password-toggle:hover {
            color: var(--primary-pink);
        }

        .input-suffix-label {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: rgba(255, 255, 255, 0.5);
            font-family: var(--font-family);
            font-size: 14px;
            font-weight: 400;
            pointer-events: none;
            margin: 0;
            padding-top: 5px;
            line-height: 1;
            height: 14px;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
            flex-shrink: 0;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--gray);
            transition: 0.4s;
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: 0.4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: var(--primary-blue);
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }

        /* Combobox Custom Styling */
        .combobox-container {
            position: relative;
            flex: 2;
            width: 100%;
        }

        .combobox {
            width: 100%;
            cursor: pointer;
            position: relative;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            font-family: var(--font-family);
            font-size: 18px;
            background: rgba(0, 0, 0, 0.5);
            border: 2px solid var(--primary-blue);
            border-radius: 12px;
            color: var(--white);
            transition: all 0.3s ease;
        }

        .combobox:hover,
        .combobox.open {
            border-color: var(--primary-pink);
        }

        .combobox-arrow {
            margin-left: 10px;
            transition: transform 0.3s ease;
        }

        .combobox.open .combobox-arrow {
            transform: rotate(180deg);
        }

        .combobox-options {
            position: absolute;
            top: calc(100% + 3px);
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.95);
            border: none;
            border-radius: 12px;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
            z-index: 1000;
        }

        .combobox-options.open {
            max-height: 200px;
            border: 2px solid var(--primary-pink);
        }

        .combobox-option {
            padding: 15px;
            cursor: pointer;
            transition: background 0.2s ease;
            font-family: var(--font-family);
            font-size: 18px;
            color: var(--white);
        }

        .combobox-option:first-child:hover {
            background: rgba(230, 71, 131, 0.2);
            border-radius: 10px 10px 0 0;
        }

        .combobox-option:last-child:hover {
            background: rgba(230, 71, 131, 0.2);
            border-radius: 0 0 10px 10px;
        }

        .combobox-option:not(:first-child):not(:last-child):hover {
            background: rgba(230, 71, 131, 0.2);
        }

        .combobox-option.selected {
            background: rgba(230, 71, 131, 0.4);
        }

        .control-panel {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .control-card {
            background: rgba(0, 188, 231, 0.1);
            border: 2px solid var(--primary-blue);
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            display: flex;
            flex-direction: column;
        }

        .control-card h3 {
            font-size: 24px;
            margin-bottom: 15px;
            color: var(--primary-blue);
        }

        .control-card-content {
            flex: 1;
            margin-bottom: 20px;
        }

        .control-card-buttons {
            margin-top: auto;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .control-card .btn {
            font-size: 20px;
            padding: 15px;
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-indicator.active {
            background: #00ff00;
            box-shadow: 0 0 10px #00ff00;
        }

        .status-indicator.inactive {
            background: #ff0000;
            box-shadow: 0 0 10px #ff0000;
        }

        /* Table Styling */
        .table-container {
            position: relative;
            margin-top: 20px;
        }

        .table-header {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            margin-bottom: 20px;
        }

        .table-header h2 {
            font-size: 32px;
            font-weight: 800;
            color: var(--primary-blue);
            margin: 0;
        }

        .table-actions {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .icon-btn {
            background: transparent;
            border: none;
            border-radius: 8px;
            padding: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .icon-btn:hover,
        .icon-btn:active {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.05);
        }

        .icon-btn svg {
            width: 20px;
            height: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 10px;
            overflow: hidden;
            table-layout: fixed;
        }

        #votingTable {
            table-layout: fixed;
        }

        #votingTable th:nth-child(1),
        #votingTable td:nth-child(1) {
            width: 15%;
        }

        #votingTable th:nth-child(2),
        #votingTable td:nth-child(2) {
            width: 15%;
        }

        #votingTable th:nth-child(3),
        #votingTable td:nth-child(3) {
            width: 15%;
        }

        #votingTable th:nth-child(4),
        #votingTable td:nth-child(4) {
            width: 15%;
        }

        #votingTable th:nth-child(5),
        #votingTable td:nth-child(5) {
            width: 40%;
        }

        thead {
            background: rgba(0, 188, 231, 0.2);
        }

        th {
            padding: 20px;
            text-align: left;
            font-size: 16px;
            font-weight: 800;
            color: var(--primary-blue);
            text-transform: uppercase;
            border-bottom: 2px solid var(--primary-blue);
        }

        td {
            padding: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 16px;
        }

        tr:hover {
            background: rgba(0, 188, 231, 0.1);
        }

        .editable-number,
        .editable-name {
            cursor: pointer;
            position: relative;
        }

        .editable-number:hover,
        .editable-name:hover {
            background: rgba(0, 188, 231, 0.2);
        }

        /* Mobile Logout */
        .mobile-logout {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--black);
            padding: 20px;
            text-align: center;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            z-index: 1000;
        }

        .mobile-logout button {
            background: transparent;
            border: none;
            color: var(--white);
            font-family: var(--font-family);
            font-size: 16px;
            font-weight: 400;
            cursor: pointer;
            padding: 0;
            text-transform: uppercase;
            transition: color 0.3s ease;
        }

        .mobile-logout button:hover {
            color: var(--primary-blue);
        }

        /* Admin Timer Critical State */
        #adminTimerDisplay.critical {
            color: #ff0000 !important;
            animation: timerPulse 1s ease-in-out infinite;
        }

        @keyframes timerPulse {
            0%, 100% {
                text-shadow: 0 0 20px rgba(255, 0, 0, 0.8),
                             0 0 40px rgba(255, 0, 0, 0.6),
                             0 0 60px rgba(255, 0, 0, 0.4);
            }
            50% {
                text-shadow: 0 0 30px rgba(255, 0, 0, 1),
                             0 0 60px rgba(255, 0, 0, 0.8),
                             0 0 90px rgba(255, 0, 0, 0.6);
            }
        }

        /* Responsive */
        @media (max-width: 900px) {
            .admin-logo {
                display: none;
            }
        }

        @media (max-width: 768px) {
            .admin-container {
                padding: 15px;
                padding-bottom: 80px;
            }

            .admin-header h1 {
                font-size: 32px;
            }

            .tabs {
                gap: 20px;
            }

            .tab {
                font-size: 16px;
                padding: 0;
            }

            .admin-header > div:last-child {
                display: none;
            }

            .settings-grid {
                grid-template-columns: 1fr;
            }

            .settings-column:first-child .form-group:last-child {
                margin-bottom: 40px;
            }

            .form-group input,
            .form-group .combobox-container {
                width: 100%;
            }

            .control-panel {
                grid-template-columns: 1fr;
            }

            table {
                font-size: 14px;
            }

            th, td {
                padding: 12px;
            }

            .mobile-logout {
                display: block;
            }
        }

        @media (max-width: 550px) {
            .tab {
                padding-top: 20px;
                font-size: 13.6px;
            }
        }

        /* Hide file input */
        #csvFileInput {
            display: none;
        }

        /* Reset Modals */
        .reset-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(10px);
        }

        .reset-modal .modal-content {
            background: rgba(255, 255, 255, 0.05);
            padding: 40px 30px;
            border-radius: 20px;
            border: 2px solid rgba(0, 188, 231, 0.3);
            max-width: 500px;
            width: 90%;
            position: relative;
        }

        .reset-modal .modal-content::before {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: 18px;
            padding: 2px;
            background: linear-gradient(135deg, rgba(0, 188, 231, 0.2), rgba(247, 34, 127, 0.2));
            -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            -webkit-mask-composite: xor;
            mask-composite: exclude;
            pointer-events: none;
        }

        .reset-modal .modal-content h2 {
            font-family: var(--font-family);
            font-size: 28px;
            font-weight: 800;
            margin: 0 0 15px 0;
            background: linear-gradient(135deg, var(--primary-blue), var(--primary-pink));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-align: center;
        }

        .reset-modal .modal-content p {
            font-family: var(--font-family);
            font-size: 16px;
            margin: 0;
            color: rgba(255, 255, 255, 0.9);
            text-align: center;
        }

        .modal-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
        }

        .modal-buttons .btn {
            flex: 1;
            min-width: 120px;
        }

        /* Override primary button color to pink for admin page */
        .btn-primary {
            background: var(--primary-pink);
            color: var(--white);
        }

        .btn-primary:hover {
            transform: scale(1.05);
            box-shadow: 0 0 30px rgba(230, 71, 131, 0.5);
            background: #f05598;
        }

        .btn-primary:active {
            transform: scale(1.02);
            box-shadow: 0 0 15px rgba(230, 71, 131, 0.7);
            background: #d13970;
        }
    </style>
</head>
<body>
    <!-- Reset All Votes Modal -->
    <div class="reset-modal" id="resetAllModal" style="display: none;">
        <div class="modal-content">
            <h2>RESET ALL VOTES</h2>
            <p>This will permanently delete all votes. This cannot be undone.</p>
            <p style="margin-top: 20px; font-size: 14px; color: var(--gray);">Enter admin passcode to confirm:</p>
            <input type="password" id="resetAllPasscode" class="passcode-input" maxlength="6" placeholder="000000" style="width: 100%; margin-top: 10px; padding: 15px; background: rgba(255,255,255,0.1); border: 2px solid rgba(255,255,255,0.2); border-radius: 10px; color: white; font-size: 20px; text-align: center; font-family: var(--font-family); font-weight: 700;">
            <div class="modal-buttons" style="margin-top: 30px;">
                <button class="btn btn-secondary" id="cancelResetAllBtn">CANCEL</button>
                <button class="btn btn-primary" id="confirmResetAllBtn">RESET ALL</button>
            </div>
        </div>
    </div>

    <!-- Reset Player Vote Modal -->
    <div class="reset-modal" id="resetPlayerModal" style="display: none;">
        <div class="modal-content">
            <h2>RESET PLAYER VOTE</h2>
            <p>Enter the player number to reset their votes:</p>
            <input type="text" id="resetPlayerNumber" class="player-input" placeholder="001" style="width: 100%; margin-top: 10px; padding: 15px; background: rgba(255,255,255,0.1); border: 2px solid rgba(255,255,255,0.2); border-radius: 10px; color: white; font-size: 20px; text-align: center; font-family: var(--font-family); font-weight: 700;">
            <p style="margin-top: 20px; font-size: 14px; color: var(--gray);">Enter admin passcode to confirm:</p>
            <input type="password" id="resetPlayerPasscode" class="passcode-input" maxlength="6" placeholder="000000" style="width: 100%; margin-top: 10px; padding: 15px; background: rgba(255,255,255,0.1); border: 2px solid rgba(255,255,255,0.2); border-radius: 10px; color: white; font-size: 20px; text-align: center; font-family: var(--font-family); font-weight: 700;">
            <div class="modal-buttons" style="margin-top: 30px;">
                <button class="btn btn-secondary" id="cancelResetPlayerBtn">CANCEL</button>
                <button class="btn btn-primary" id="confirmResetPlayerBtn">RESET PLAYER</button>
            </div>
        </div>
    </div>

    <!-- Reset Last Round Modal -->
    <div class="reset-modal" id="resetRoundModal" style="display: none;">
        <div class="modal-content">
            <h2>RESET LAST ROUND</h2>
            <p>This will delete all votes from round <span id="lastRoundNumber"></span>. This cannot be undone.</p>
            <p style="margin-top: 20px; font-size: 14px; color: var(--gray);">Enter admin passcode to confirm:</p>
            <input type="password" id="resetRoundPasscode" class="passcode-input" maxlength="6" placeholder="000000" style="width: 100%; margin-top: 10px; padding: 15px; background: rgba(255,255,255,0.1); border: 2px solid rgba(255,255,255,0.2); border-radius: 10px; color: white; font-size: 20px; text-align: center; font-family: var(--font-family); font-weight: 700;">
            <div class="modal-buttons" style="margin-top: 30px;">
                <button class="btn btn-secondary" id="cancelResetRoundBtn">CANCEL</button>
                <button class="btn btn-primary" id="confirmResetRoundBtn">RESET ROUND</button>
            </div>
        </div>
    </div>

    <!-- Restart Modal -->
    <div class="reset-modal" id="restartModal" style="display: none;">
        <div class="modal-content">
            <h2>RESTART GAME</h2>
            <p>This will reset the game to Round 1 and clear all votes. This cannot be undone.</p>
            <p style="margin-top: 20px; font-size: 14px; color: var(--gray);">Enter admin passcode to confirm:</p>
            <input type="password" id="restartPasscode" class="passcode-input" maxlength="6" placeholder="000000" style="width: 100%; margin-top: 10px; padding: 15px; background: rgba(255,255,255,0.1); border: 2px solid rgba(255,255,255,0.2); border-radius: 10px; color: white; font-size: 20px; text-align: center; font-family: var(--font-family); font-weight: 700;">
            <div class="modal-buttons" style="margin-top: 30px;">
                <button class="btn btn-secondary" id="cancelRestartBtn">CANCEL</button>
                <button class="btn btn-primary" id="confirmRestartBtn">RESTART</button>
            </div>
        </div>
    </div>

    <div class="admin-container">
        <div class="admin-header">
            <div class="tabs">
                <button class="tab active" data-tab="control">CONTROL</button>
                <button class="tab" data-tab="players">PLAYERS</button>
                <button class="tab" data-tab="voting">VOTING</button>
                <button class="tab" data-tab="config">SETTINGS</button>
            </div>
            <div style="display: flex; align-items: center; gap: 20px;">
                <img src="/images/BeastPick.png" alt="Beast Pick Logo" class="admin-logo">
                <button class="lock-btn" onclick="logout()">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <rect x="5" y="11" width="14" height="10" rx="2" stroke="white" stroke-width="2" opacity="0.6"/>
                        <path d="M8 11V7a4 4 0 0 1 8 0v4" stroke="white" stroke-width="2" stroke-linecap="round" opacity="0.6"/>
                        <circle cx="12" cy="16" r="1.5" fill="white" opacity="0.6"/>
                    </svg>
                </button>
            </div>
        </div>

        <!-- Control Tab -->
        <div class="tab-content active" id="control">
            <div class="control-panel">
                <div class="control-card">
                    <h3>VOTING</h3>
                    <div class="control-card-content">
                        <p><span class="status-indicator inactive" id="votingStatusIndicator"></span><span id="votingStatusText">Voting Locked</span></p>
                        <div id="adminTimerDisplay" style="display: none; font-size: 86px; font-weight: 800; color: var(--primary-blue); margin-top: 15px;">0:00</div>
                    </div>
                    <div class="control-card-buttons">
                        <button class="btn btn-primary" id="votingToggleBtn" onclick="toggleVotingLock()">START</button>
                    </div>
                </div>

                <div class="control-card">
                    <h3>ROUND</h3>
                    <div class="control-card-content">
                        <p id="currentRoundDisplay" style="font-size: 48px; font-weight: 800; color: var(--primary-blue);">1</p>
                    </div>
                    <div class="control-card-buttons">
                        <button class="btn btn-primary" onclick="startNewRound()">NEXT ROUND</button>
                        <button class="btn btn-secondary" onclick="restartGame()">RESTART</button>
                    </div>
                </div>

                <div class="control-card">
                    <h3>RESET</h3>
                    <div class="control-card-content"></div>
                    <div class="control-card-buttons">
                        <button class="btn btn-primary" onclick="resetAllVotes()">ALL VOTES</button>
                        <button class="btn btn-secondary" onclick="resetPlayerVote()">PLAYER</button>
                        <button class="btn btn-secondary" onclick="resetLastRound()">LAST ROUND</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Players Tab -->
        <div class="tab-content" id="players">
            <div class="table-container">
                <div class="table-header">
                    <div class="table-actions">
                        <button class="icon-btn" title="Import CSV" onclick="document.getElementById('csvFileInput').click()">
                            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M12 15V3m0 12l-4-4m4 4l4-4M2 17l.621 2.485A2 2 0 004.561 21h14.878a2 2 0 001.94-1.515L22 17" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </button>
                        <button class="icon-btn" title="Export CSV" onclick="exportPlayersCSV()">
                            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M12 15V3m0 0l-4 4m4-4l4 4M2 17l.621 2.485A2 2 0 004.561 21h14.878a2 2 0 001.94-1.515L22 17" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </button>
                        <button class="icon-btn" title="Add Player" onclick="addPlayerToTable()">
                            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M12 5v14m-7-7h14" stroke="white" stroke-width="2" stroke-linecap="round"/>
                            </svg>
                        </button>
                    </div>
                </div>
                <input type="file" id="csvFileInput" accept=".csv" onchange="importPlayersCSV(event)">
                <table>
                    <thead>
                        <tr>
                            <th>Number</th>
                            <th>Name</th>
                            <th>Status</th>
                            <th style="width: 60px;"></th>
                        </tr>
                    </thead>
                    <tbody id="playersTableBody">
                        <tr>
                            <td>001</td>
                            <td>Player One</td>
                            <td>Active</td>
                            <td>150 lbs</td>
                        </tr>
                        <tr>
                            <td>002</td>
                            <td>Player Two</td>
                            <td>Active</td>
                            <td>225 lbs</td>
                        </tr>
                        <tr>
                            <td>009</td>
                            <td>Supercalifragilisticespi</td>
                            <td>Eliminated</td>
                            <td>165 lbs</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Settings Tab -->
        <div class="tab-content" id="config">
            <div class="settings-grid">
                <!-- Left Column -->
                <div class="settings-column">
                    <!-- Logo -->
                    <div class="form-group">
                        <label class="field-label">Logo</label>
                        <input type="file" id="logoUpload" accept=".png" style="display: none;" onchange="handleLogoUpload(event)">
                        <div class="logo-preview-clickable" id="logoPreview" onclick="document.getElementById('logoUpload').click()">
                            <div class="logo-preview-placeholder" id="logoPlaceholder">Click to upload logo</div>
                            <img id="logoPreviewImage" style="display: none;" alt="Logo Preview">
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Voting For</label>
                        <div class="combobox-container">
                            <div class="combobox" onclick="toggleCombobox(this)">
                                <span id="selectedVotingMode">Player</span>
                                <svg class="combobox-arrow" width="12" height="8" viewBox="0 0 12 8" fill="white">
                                    <path d="M1 1l5 5 5-5"/>
                                </svg>
                            </div>
                            <div class="combobox-options">
                                <div class="combobox-option selected" onclick="selectOption(this, 'player')">Player</div>
                                <div class="combobox-option" onclick="selectOption(this, 'quantity-player')">Quantity & Player</div>
                                <div class="combobox-option" onclick="selectOption(this, 'option-player')">Option & Player</div>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Submission Type</label>
                        <div class="combobox-container">
                            <div class="combobox" onclick="toggleCombobox(this)">
                                <span id="selectedSubmissionType">Single Vote - Instant</span>
                                <svg class="combobox-arrow" width="12" height="8" viewBox="0 0 12 8" fill="white">
                                    <path d="M1 1l5 5 5-5"/>
                                </svg>
                            </div>
                            <div class="combobox-options">
                                <div class="combobox-option selected" onclick="selectOption(this, 'instant')">Single Vote - Instant</div>
                                <div class="combobox-option" onclick="selectOption(this, 'timed-batch')">Single Vote - Time Based</div>
                                <div class="combobox-option" onclick="selectOption(this, 'batch')">Multiple Votes - Time Based</div>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="field-label">Player's Name</label>
                        <div class="combobox-container">
                            <div class="combobox" onclick="toggleCombobox(this)">
                                <span id="selectedPlayerName">Show</span>
                                <svg width="12" height="8" viewBox="0 0 12 8" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M1 1.5L6 6.5L11 1.5" stroke="white" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                            </div>
                            <div class="combobox-options">
                                <div class="combobox-option" onclick="selectOption(this, 'show')">Show</div>
                                <div class="combobox-option" onclick="selectOption(this, 'hide')">Hide</div>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="field-label">Eliminated Players</label>
                        <div class="combobox-container">
                            <div class="combobox" onclick="toggleCombobox(this)">
                                <span id="selectedEliminatedPlayers">Show</span>
                                <svg width="12" height="8" viewBox="0 0 12 8" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M1 1.5L6 6.5L11 1.5" stroke="white" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                            </div>
                            <div class="combobox-options">
                                <div class="combobox-option" onclick="selectOption(this, 'show')">Show</div>
                                <div class="combobox-option" onclick="selectOption(this, 'hide')">Hide</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Middle Column (Empty) -->
                <div></div>

                <!-- Right Column -->
                <div class="settings-column">
                    <div class="form-group" id="voteIncrementGroup">
                        <label class="field-label">Vote Increment</label>
                        <input type="number" id="voteIncrement" value="1" placeholder="1" oninput="autoSaveSettings()" onkeypress="return event.charCode >= 48 && event.charCode <= 57" min="1" step="1">
                    </div>

                    <div class="form-group" id="unitGroup">
                        <label class="field-label">Unit of Measurement</label>
                        <input type="text" id="unit" value="" placeholder="" maxlength="3" oninput="autoSaveSettings()">
                    </div>

                    <div class="form-group" id="option1Group" style="display: none;">
                        <label class="field-label">Option 1</label>
                        <input type="text" id="option1Label" value="Yes" placeholder="Yes" oninput="autoSaveSettings()">
                    </div>

                    <div class="form-group" id="option2Group" style="display: none;">
                        <label class="field-label">Option 2</label>
                        <input type="text" id="option2Label" value="No" placeholder="No" oninput="autoSaveSettings()">
                    </div>

                    <div class="form-group">
                        <label class="field-label">Timer</label>
                        <div class="combobox-container">
                            <div class="combobox" onclick="toggleCombobox(this)">
                                <span id="selectedTimerVisibility">Show</span>
                                <svg width="12" height="8" viewBox="0 0 12 8" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M1 1.5L6 6.5L11 1.5" stroke="white" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                            </div>
                            <div class="combobox-options">
                                <div class="combobox-option" onclick="selectOption(this, 'show')">Show</div>
                                <div class="combobox-option" onclick="selectOption(this, 'hide')">Hide</div>
                            </div>
                        </div>
                    </div>

                    <div class="form-group" id="timerDurationGroup">
                        <label class="field-label">Timer Duration</label>
                        <div class="input-with-label">
                            <input type="number" id="timerDuration" value="60" placeholder="60" oninput="autoSaveSettings()" onkeypress="return event.charCode >= 48 && event.charCode <= 57" min="1" step="1" style="padding-right: 75px;">
                            <span class="input-suffix-label">seconds</span>
                        </div>
                    </div>

                    <div class="form-group" id="securityPasscodeGroup">
                        <label class="field-label">Security Passcode</label>
                        <div class="password-input-wrapper">
                            <input type="password" id="securityPasscode" value="123456" maxlength="6" pattern="[0-9]{6}" inputmode="numeric" oninput="validatePasscode(this)" onchange="autoSaveSettings()" style="padding-right: 60px;">
                            <button type="button" class="password-toggle" onclick="togglePasswordVisibility()">Show</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Voting Tab -->
        <div class="tab-content" id="voting">
            <div class="table-container">
                <div class="table-header">
                    <div class="table-actions">
                        <button class="icon-btn" title="Export CSV" onclick="exportVotingCSV()">
                            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M12 15V3m0 0l-4 4m4-4l4 4M2 17l.621 2.485A2 2 0 004.561 21h14.878a2 2 0 001.94-1.515L22 17" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </button>
                    </div>
                </div>
                <table id="votingTable">
                    <thead>
                        <tr>
                            <th>Round</th>
                            <th>Player</th>
                            <th>Target</th>
                            <th>Voted</th>
                            <th>When</th>
                        </tr>
                    </thead>
                    <tbody id="votingTableBody">
                        <tr>
                            <td>1</td>
                            <td>001</td>
                            <td>002</td>
                            <td>15 lbs</td>
                            <td>Jan 22, 2025 - 14:35:22 EST</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script src="/js/auth.js"></script>
    <script src="/js/data.js"></script>
    <script>
        // Check authentication
        if (!checkAuthentication('admin')) {
            // Will redirect if not authenticated
        }

        // Load players table
        async function loadPlayersTable() {
            const players = await getPlayers();
            const config = await getGameConfig();
            const tbody = document.getElementById('playersTableBody');

            tbody.innerHTML = players.map(player => `
                <tr data-player-id="${player.id}">
                    <td class="editable-number" data-player-id="${player.id}" data-field="number">${player.number}</td>
                    <td class="editable-name" data-player-id="${player.id}" data-field="name">${player.name}</td>
                    <td class="status-toggle" data-player-id="${player.id}" style="cursor: pointer;">${player.status}</td>
                    <td style="text-align: right; padding-right: 20px;">
                        <button class="icon-btn" title="Delete Player" onclick="deletePlayer(${player.id})" style="padding: 8px;">
                            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M3 6h18M8 6V4a2 2 0 012-2h4a2 2 0 012 2v2m3 0v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6h14z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M10 11v6M14 11v6" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </button>
                    </td>
                </tr>
            `).join('');

            // Add click handlers for editable fields
            document.querySelectorAll('.editable-number, .editable-name').forEach(cell => {
                cell.addEventListener('click', function() {
                    makeEditable(this);
                });
            });

            // Add click handler for status toggle
            document.querySelectorAll('.status-toggle').forEach(cell => {
                cell.addEventListener('click', async function() {
                    const playerId = parseInt(this.dataset.playerId);
                    const currentStatus = this.textContent.trim();
                    const newStatus = currentStatus === 'Active' ? 'Eliminated' : 'Active';

                    await updatePlayer(playerId, { status: newStatus });
                    this.textContent = newStatus;

                    // Visual feedback for auto-save
                    this.style.background = 'rgba(0, 188, 231, 0.3)';
                    setTimeout(() => {
                        this.style.background = '';
                    }, 300);
                });
            });
        }

        // Make cell editable
        function makeEditable(cell) {
            const playerId = parseInt(cell.dataset.playerId);
            const field = cell.dataset.field;
            const currentText = cell.textContent.trim();

            // Create input field
            const input = document.createElement('input');
            input.type = 'text';
            input.value = currentText;
            input.style.cssText = 'background: transparent; border: none; color: var(--white); font-family: var(--font-family); font-size: 16px; width: 100%; outline: none;';

            // Replace cell content with input
            cell.textContent = '';
            cell.appendChild(input);
            input.focus();
            input.select();

            // Save on blur or enter
            const saveEdit = async () => {
                const newValue = input.value.trim();
                if (newValue && newValue !== currentText) {
                    await updatePlayer(playerId, { [field]: newValue });
                    cell.textContent = newValue;

                    // Visual feedback for auto-save
                    cell.style.background = 'rgba(0, 188, 231, 0.3)';
                    setTimeout(() => {
                        cell.style.background = '';
                    }, 300);
                } else {
                    cell.textContent = currentText;
                }
            };

            input.addEventListener('blur', saveEdit);
            input.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    input.blur();
                }
            });
        }

        // Load saved settings
        async function loadSavedSettings() {
            try {
                const config = await getGameConfig();

                // Update combobox values
                if (config.votingMode) {
                    const votingModeText = config.votingMode.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase()).replace(/ And /g, ' & ');
                    document.getElementById('selectedVotingMode').textContent = votingModeText;
                }

                if (config.submissionType) {
                    const submissionTypeText = config.submissionType.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                    document.getElementById('selectedSubmissionType').textContent = submissionTypeText;
                }

                if (config.playerName) {
                    document.getElementById('selectedPlayerName').textContent = config.playerName.charAt(0).toUpperCase() + config.playerName.slice(1);
                }

                if (config.eliminatedPlayers) {
                    document.getElementById('selectedEliminatedPlayers').textContent = config.eliminatedPlayers.charAt(0).toUpperCase() + config.eliminatedPlayers.slice(1);
                }

                if (config.timerVisibility) {
                    document.getElementById('selectedTimerVisibility').textContent = config.timerVisibility.charAt(0).toUpperCase() + config.timerVisibility.slice(1);
                }

                // Update input values
                if (config.voteIncrement !== undefined) {
                    document.getElementById('voteIncrement').value = config.voteIncrement;
                }

                if (config.unit !== undefined) {
                    document.getElementById('unit').value = config.unit;
                }

                if (config.timerDuration !== undefined) {
                    document.getElementById('timerDuration').value = config.timerDuration;
                }

                if (config.option1Label !== undefined) {
                    document.getElementById('option1Label').value = config.option1Label;
                }

                if (config.option2Label !== undefined) {
                    document.getElementById('option2Label').value = config.option2Label;
                }

                if (config.securityPasscode !== undefined) {
                    document.getElementById('securityPasscode').value = config.securityPasscode;
                }

                if (config.currentRound !== undefined) {
                    document.getElementById('currentRoundDisplay').textContent = config.currentRound;
                }

                if (config.customLogo) {
                    updateLogoPreview(config.customLogo);
                }

                // Update voting lock status (default to locked)
                const votingLocked = config.votingLocked !== undefined ? config.votingLocked : true;
                updateVotingLockUI(votingLocked);

                // Update voting mode visibility
                updateVotingModeVisibility();
            } catch (error) {
                console.error('Error loading settings:', error);
            }
        }

        // Load players on page load
        document.addEventListener('DOMContentLoaded', () => {
            loadPlayersTable();
            loadSavedSettings();

            // Add event listeners to settings inputs for auto-save
            document.getElementById('voteIncrement')?.addEventListener('change', autoSaveSettings);
            document.getElementById('unit')?.addEventListener('change', autoSaveSettings);
            document.getElementById('timerDuration')?.addEventListener('change', autoSaveSettings);
            document.getElementById('securityPasscode')?.addEventListener('change', autoSaveSettings);

            // Initialize voting mode visibility
            updateVotingModeVisibility();
        });

        // Tab switching
        const tabs = document.querySelectorAll('.tab');
        const tabContents = document.querySelectorAll('.tab-content');

        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                const targetTab = tab.dataset.tab;

                tabs.forEach(t => t.classList.remove('active'));
                tabContents.forEach(tc => tc.classList.remove('active'));

                tab.classList.add('active');
                document.getElementById(targetTab).classList.add('active');
            });
        });

        // Combobox functionality
        function toggleCombobox(element) {
            const container = element.parentElement;
            const options = container.querySelector('.combobox-options');
            element.classList.toggle('open');
            options.classList.toggle('open');

            // Close when clicking outside
            if (element.classList.contains('open')) {
                setTimeout(() => {
                    document.addEventListener('click', function closeCombobox(e) {
                        if (!container.contains(e.target)) {
                            element.classList.remove('open');
                            options.classList.remove('open');
                            document.removeEventListener('click', closeCombobox);
                        }
                    });
                }, 0);
            }
        }

        function selectOption(optionElement, value) {
            const container = optionElement.parentElement.parentElement;
            const combobox = container.querySelector('.combobox');

            // Handle different combobox types
            let selectedText;
            if (container.querySelector('#selectedVotingMode')) {
                selectedText = container.querySelector('#selectedVotingMode');
            } else if (container.querySelector('#selectedSubmissionType')) {
                selectedText = container.querySelector('#selectedSubmissionType');
            } else if (container.querySelector('#selectedEliminatedPlayers')) {
                selectedText = container.querySelector('#selectedEliminatedPlayers');
            } else if (container.querySelector('#selectedPlayerName')) {
                selectedText = container.querySelector('#selectedPlayerName');
            } else {
                selectedText = container.querySelector('#selectedMode');
            }

            const allOptions = container.querySelectorAll('.combobox-option');

            allOptions.forEach(opt => opt.classList.remove('selected'));
            optionElement.classList.add('selected');
            selectedText.textContent = optionElement.textContent;

            combobox.classList.remove('open');
            optionElement.parentElement.classList.remove('open');

            // Update visibility based on voting mode
            updateVotingModeVisibility();

            autoSaveSettings();
        }

        // Update voting mode visibility
        function updateVotingModeVisibility() {
            const votingMode = document.querySelector('#selectedVotingMode')?.textContent.toLowerCase().replace(/ & /g, '-').replace(/ /g, '-') || 'player';
            const voteIncrementGroup = document.getElementById('voteIncrementGroup');
            const unitGroup = document.getElementById('unitGroup');
            const option1Group = document.getElementById('option1Group');
            const option2Group = document.getElementById('option2Group');

            // Show/hide fields based on voting mode
            if (votingMode === 'quantity-player') {
                voteIncrementGroup.style.display = 'block';
                unitGroup.style.display = 'block';
                option1Group.style.display = 'none';
                option2Group.style.display = 'none';
            } else if (votingMode === 'option-player') {
                voteIncrementGroup.style.display = 'none';
                unitGroup.style.display = 'none';
                option1Group.style.display = 'block';
                option2Group.style.display = 'block';
            } else {
                voteIncrementGroup.style.display = 'none';
                unitGroup.style.display = 'none';
                option1Group.style.display = 'none';
                option2Group.style.display = 'none';
            }
        }

        // Auto-save settings
        async function autoSaveSettings() {
            try {
                // Collect all settings
                const settings = {
                    votingMode: document.querySelector('#selectedVotingMode')?.textContent.toLowerCase().replace(/ & /g, '-').replace(/ /g, '-') || 'player',
                    submissionType: document.querySelector('#selectedSubmissionType')?.textContent.toLowerCase().replace(/ /g, '-') || 'instant-submit',
                    playerName: document.querySelector('#selectedPlayerName')?.textContent.toLowerCase() || 'show',
                    eliminatedPlayers: document.querySelector('#selectedEliminatedPlayers')?.textContent.toLowerCase() || 'show',
                    timerVisibility: document.querySelector('#selectedTimerVisibility')?.textContent.toLowerCase() || 'show',
                    voteIncrement: parseInt(document.getElementById('voteIncrement')?.value) || 15,
                    unit: document.getElementById('unit')?.value || 'lbs',
                    timerDuration: parseInt(document.getElementById('timerDuration')?.value) || 60,
                    option1Label: document.getElementById('option1Label')?.value || 'Yes',
                    option2Label: document.getElementById('option2Label')?.value || 'No',
                    securityPasscode: document.getElementById('securityPasscode')?.value || ''
                };

                // Save to backend
                await updateGameConfig(settings);
                console.log('Settings auto-saved:', settings);
            } catch (error) {
                console.error('Error saving settings:', error);
            }
        }

        // Toggle voting lock
        async function toggleVotingLock() {
            try {
                const config = await getGameConfig();
                const currentlyLocked = config.votingLocked !== undefined ? config.votingLocked : true;
                const newLockedState = !currentlyLocked;

                // Update Firebase
                await updateGameConfig({
                    votingLocked: newLockedState,
                    timerStartTime: newLockedState ? null : Date.now()
                });

                // Update UI
                updateVotingLockUI(newLockedState);

                console.log(`Voting ${newLockedState ? 'locked' : 'unlocked'}`);
            } catch (error) {
                console.error('Error toggling voting lock:', error);
                alert('Error toggling voting lock');
            }
        }

        // Admin timer countdown
        let adminTimerInterval;
        let adminTimeRemaining = 0;

        async function startAdminTimer() {
            try {
                const config = await getGameConfig();

                if (!config.votingLocked && config.timerDuration > 0) {
                    // Calculate time remaining based on start time
                    if (config.timerStartTime) {
                        const elapsed = Math.floor((Date.now() - config.timerStartTime) / 1000);
                        adminTimeRemaining = Math.max(0, config.timerDuration - elapsed);
                    } else {
                        adminTimeRemaining = config.timerDuration;
                    }

                    document.getElementById('adminTimerDisplay').style.display = 'block';
                    updateAdminTimerDisplay();

                    if (adminTimerInterval) clearInterval(adminTimerInterval);

                    adminTimerInterval = setInterval(async () => {
                        if (adminTimeRemaining > 0) {
                            adminTimeRemaining--;
                            updateAdminTimerDisplay();
                        } else {
                            // Timer reached 0 - automatically lock voting
                            clearInterval(adminTimerInterval);
                            document.getElementById('adminTimerDisplay').style.display = 'none';

                            try {
                                // Lock voting in Firebase
                                await updateGameConfig({ votingLocked: true });
                                // Update UI
                                updateVotingLockUI(true);
                                console.log('Voting automatically locked - timer expired');
                            } catch (error) {
                                console.error('Error auto-locking voting:', error);
                            }
                        }
                    }, 1000);
                } else {
                    document.getElementById('adminTimerDisplay').style.display = 'none';
                    if (adminTimerInterval) clearInterval(adminTimerInterval);
                }
            } catch (error) {
                console.error('Error starting admin timer:', error);
            }
        }

        function updateAdminTimerDisplay() {
            const minutes = Math.floor(adminTimeRemaining / 60);
            const seconds = adminTimeRemaining % 60;
            const display = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            const timerElement = document.getElementById('adminTimerDisplay');
            timerElement.textContent = display;

            // Add critical class for last 5 seconds
            if (adminTimeRemaining <= 5 && adminTimeRemaining > 0) {
                timerElement.classList.add('critical');
            } else {
                timerElement.classList.remove('critical');
            }
        }

        // Update voting lock UI
        function updateVotingLockUI(isLocked) {
            const indicator = document.getElementById('votingStatusIndicator');
            const statusText = document.getElementById('votingStatusText');
            const toggleBtn = document.getElementById('votingToggleBtn');

            if (isLocked) {
                // Voting is locked
                indicator.classList.remove('active');
                indicator.classList.add('inactive');
                statusText.textContent = 'Voting Locked';
                toggleBtn.textContent = 'START';
                document.getElementById('adminTimerDisplay').style.display = 'none';
                if (adminTimerInterval) clearInterval(adminTimerInterval);
            } else {
                // Voting is unlocked/on
                indicator.classList.remove('inactive');
                indicator.classList.add('active');
                statusText.textContent = 'Voting On';
                toggleBtn.textContent = 'LOCK';
                startAdminTimer();
            }
        }

        // Start new round
        async function startNewRound() {
            if (!confirm('Are you sure you want to start a new round? This will refresh all voting pages.')) {
                return;
            }

            try {
                const config = await getGameConfig();
                const newRound = (config.currentRound || 1) + 1;

                await updateGameConfig({ currentRound: newRound });

                // Update the display
                document.getElementById('currentRoundDisplay').textContent = newRound;

                alert(`New round ${newRound} started! All voting pages will refresh.`);
            } catch (error) {
                console.error('Error starting new round:', error);
                alert('Error starting new round');
            }
        }

        // Helper function to verify passcode
        async function verifyPasscode(inputPasscode) {
            const config = await getGameConfig();
            const adminPasscode = config.securityPasscode || '';

            // If no passcode is set, allow the action
            if (!adminPasscode) {
                return true;
            }

            return inputPasscode === adminPasscode;
        }

        // Show modal helper
        function showModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.style.display = 'flex';
            }
        }

        // Hide modal helper
        function hideModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.style.display = 'none';
                // Clear input fields
                const inputs = modal.querySelectorAll('input');
                inputs.forEach(input => input.value = '');
            }
        }

        // Reset all votes
        async function resetAllVotes() {
            showModal('resetAllModal');
        }

        // Reset individual player vote
        async function resetPlayerVote() {
            showModal('resetPlayerModal');
        }

        // Reset last round
        async function resetLastRound() {
            const config = await getGameConfig();
            const currentRound = config.currentRound || 1;

            if (currentRound <= 1) {
                alert('No previous round to reset');
                return;
            }

            document.getElementById('lastRoundNumber').textContent = currentRound - 1;
            showModal('resetRoundModal');
        }

        // Restart game
        async function restartGame() {
            showModal('restartModal');
        }

        // Toggle input field visibility based on switch state
        function toggleInput(checkbox) {
            const container = checkbox.closest('.input-with-toggle');
            const inputField = container.querySelector('input[type="number"], input[type="text"], input[type="tel"]');

            if (checkbox.checked) {
                inputField.classList.remove('hidden');
                container.classList.remove('no-input');
            } else {
                inputField.classList.add('hidden');
                container.classList.add('no-input');
            }

            autoSaveSettings();
        }

        // Validate passcode (must be exactly 6 digits)
        function validatePasscode(input) {
            input.value = input.value.replace(/\D/g, '').slice(0, 6);
        }

        // Toggle password visibility
        function togglePasswordVisibility() {
            const passwordInput = document.getElementById('securityPasscode');
            const toggleButton = document.querySelector('.password-toggle');

            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                toggleButton.textContent = 'Hide';
            } else {
                passwordInput.type = 'password';
                toggleButton.textContent = 'Show';
            }
        }

        // Handle logo upload
        async function handleLogoUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Validate file type
            if (!file.type.match('image/png')) {
                alert('Only PNG files are allowed');
                event.target.value = '';
                return;
            }

            // Convert to base64 and save
            const reader = new FileReader();
            reader.onload = async function(e) {
                const logoDataUrl = e.target.result;

                // Update preview
                updateLogoPreview(logoDataUrl);

                try {
                    await updateGameConfig({ customLogo: logoDataUrl });
                    alert('Logo uploaded successfully!');
                } catch (error) {
                    console.error('Error saving logo:', error);
                    alert('Error saving logo');
                }
            };
            reader.readAsDataURL(file);
        }

        // Update logo preview
        function updateLogoPreview(logoDataUrl) {
            const placeholder = document.getElementById('logoPlaceholder');
            const previewImage = document.getElementById('logoPreviewImage');

            if (logoDataUrl) {
                placeholder.style.display = 'none';
                previewImage.src = logoDataUrl;
                previewImage.style.display = 'block';
            } else {
                placeholder.style.display = 'block';
                previewImage.style.display = 'none';
                previewImage.src = '';
            }
        }

        // Date formatting helper for voting table
        function formatVotingDate(dateString) {
            // Input: "2025-01-22 14:35:22" or Date object
            // Output: "Jan 22, 2025 - 14:35:22 EST"
            const date = typeof dateString === 'string' ? new Date(dateString) : dateString;

            // Convert to EST timezone
            const estDate = new Date(date.toLocaleString('en-US', { timeZone: 'America/New_York' }));

            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            const month = months[estDate.getMonth()];
            const day = estDate.getDate();
            const year = estDate.getFullYear();

            const hours = String(estDate.getHours()).padStart(2, '0');
            const minutes = String(estDate.getMinutes()).padStart(2, '0');
            const seconds = String(estDate.getSeconds()).padStart(2, '0');

            return `${month} ${day}, ${year} - ${hours}:${minutes}:${seconds} EST`;
        }

        // Players management
        async function addPlayerToTable() {
            try {
                console.log('Add Player button clicked');
                const players = await getPlayers();
                console.log('Current players:', players);
                const maxId = Math.max(...players.map(p => p.id), 0);
                const newId = maxId + 1;
                const newPlayerNumber = String(newId).padStart(3, '0');
                const newPlayer = {
                    id: newId,
                    number: newPlayerNumber,
                    name: `Player ${newPlayerNumber}`,
                    photoUrl: null,
                    status: 'Active'
                };
                console.log('Adding new player:', newPlayer);
                const result = await addPlayer(newPlayer);
                console.log('Add player result:', result);
                await loadPlayersTable();
                console.log('Table reloaded');
            } catch (error) {
                console.error('Error adding player:', error);
            }
        }

        async function deletePlayer(playerId) {
            try {
                const response = await fetch('/api/players', {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ id: playerId })
                });

                const result = await response.json();

                if (result.success) {
                    await loadPlayersTable();
                } else {
                    alert('Error deleting player');
                }
            } catch (error) {
                console.error('Error deleting player:', error);
                alert('Error deleting player');
            }
        }

        async function exportPlayersCSV() {
            const players = await getPlayers();
            const config = await getGameConfig();

            // Create CSV content
            let csv = 'Number,Name,Status\n';
            players.forEach(player => {
                csv += `${player.number},"${player.name}",${player.status}\n`;
            });

            // Download CSV
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'players.csv';
            a.click();
            window.URL.revokeObjectURL(url);
        }

        async function importPlayersCSV(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async function(e) {
                const text = e.target.result;
                const lines = text.split('\n');
                const players = await getPlayers();

                // Skip header line, parse CSV
                for (let i = 1; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (!line) continue;

                    // Simple CSV parsing (handles quoted fields)
                    const matches = line.match(/(".*?"|[^,]+)(?=\s*,|\s*$)/g);
                    if (matches && matches.length >= 4) {
                        const number = matches[0].replace(/"/g, '');
                        const name = matches[1].replace(/"/g, '');
                        const status = matches[2].replace(/"/g, '');
                        const voted = matches[3].replace(/"/g, '');

                        const existingPlayer = players.find(p => p.number === number);
                        if (existingPlayer) {
                            await updatePlayer(existingPlayer.id, { name, status, voted });
                        } else {
                            await addPlayer({
                                id: Math.max(...players.map(p => p.id), 0) + 1,
                                number,
                                name,
                                photoUrl: null,
                                status,
                                voted,
                                eliminated: status === 'Eliminated'
                            });
                        }
                    }
                }

                await loadPlayersTable();
            };
            reader.readAsText(file);

            // Reset file input
            event.target.value = '';
        }

        // Voting management
        function exportVotingCSV() {
            const votingData = [
                { round: 1, player: '001', target: '002', votes: '15 lbs', when: '2025-01-22 14:35:22' }
            ];

            // Create CSV content
            let csv = 'Round,Player,Target,Votes,When\n';
            votingData.forEach(vote => {
                csv += `${vote.round},${vote.player},${vote.target},"${vote.votes}","${vote.when}"\n`;
            });

            // Download CSV
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'voting_data.csv';
            a.click();
            window.URL.revokeObjectURL(url);
        }

        // Modal Event Handlers
        // Reset All Votes Modal
        document.getElementById('cancelResetAllBtn').addEventListener('click', () => {
            hideModal('resetAllModal');
        });

        document.getElementById('confirmResetAllBtn').addEventListener('click', async () => {
            const passcode = document.getElementById('resetAllPasscode').value;

            if (!(await verifyPasscode(passcode))) {
                alert('Incorrect passcode');
                return;
            }

            try {
                const response = await fetch('/api/votes?type=all', {
                    method: 'DELETE'
                });

                const result = await response.json();

                if (result.success) {
                    hideModal('resetAllModal');
                    alert(`Successfully deleted ${result.deletedCount} votes`);
                } else {
                    alert('Error resetting votes');
                }
            } catch (error) {
                console.error('Error resetting all votes:', error);
                alert('Error resetting all votes');
            }
        });

        // Reset Player Vote Modal
        document.getElementById('cancelResetPlayerBtn').addEventListener('click', () => {
            hideModal('resetPlayerModal');
        });

        document.getElementById('confirmResetPlayerBtn').addEventListener('click', async () => {
            const playerNumber = document.getElementById('resetPlayerNumber').value;
            const passcode = document.getElementById('resetPlayerPasscode').value;

            if (!playerNumber) {
                alert('Please enter a player number');
                return;
            }

            if (!(await verifyPasscode(passcode))) {
                alert('Incorrect passcode');
                return;
            }

            try {
                const response = await fetch(`/api/votes?type=player&playerNumber=${playerNumber}`, {
                    method: 'DELETE'
                });

                const result = await response.json();

                if (result.success) {
                    hideModal('resetPlayerModal');
                    alert(`Successfully deleted ${result.deletedCount} votes for player ${playerNumber}`);
                } else {
                    alert('Error resetting player votes');
                }
            } catch (error) {
                console.error('Error resetting player votes:', error);
                alert('Error resetting player votes');
            }
        });

        // Reset Last Round Modal
        document.getElementById('cancelResetRoundBtn').addEventListener('click', () => {
            hideModal('resetRoundModal');
        });

        document.getElementById('confirmResetRoundBtn').addEventListener('click', async () => {
            const passcode = document.getElementById('resetRoundPasscode').value;
            const config = await getGameConfig();
            const lastRound = (config.currentRound || 1) - 1;

            if (!(await verifyPasscode(passcode))) {
                alert('Incorrect passcode');
                return;
            }

            try {
                const response = await fetch(`/api/votes?type=round&round=${lastRound}`, {
                    method: 'DELETE'
                });

                const result = await response.json();

                if (result.success) {
                    hideModal('resetRoundModal');
                    alert(`Successfully deleted ${result.deletedCount} votes from round ${lastRound}`);
                } else {
                    alert('Error resetting round votes');
                }
            } catch (error) {
                console.error('Error resetting round votes:', error);
                alert('Error resetting round votes');
            }
        });

        // Restart Game Modal
        document.getElementById('cancelRestartBtn').addEventListener('click', () => {
            hideModal('restartModal');
        });

        document.getElementById('confirmRestartBtn').addEventListener('click', async () => {
            const passcode = document.getElementById('restartPasscode').value;

            if (!(await verifyPasscode(passcode))) {
                alert('Incorrect passcode');
                return;
            }

            try {
                // Reset to round 1
                await updateGameConfig({ currentRound: 1 });

                // Delete all votes
                const response = await fetch('/api/votes?type=all', {
                    method: 'DELETE'
                });

                const result = await response.json();

                if (result.success) {
                    hideModal('restartModal');
                    document.getElementById('currentRoundDisplay').textContent = '1';
                    alert('Game restarted successfully');
                } else {
                    alert('Error restarting game');
                }
            } catch (error) {
                console.error('Error restarting game:', error);
                alert('Error restarting game');
            }
        });
    </script>

    <!-- Mobile Logout Button -->
    <div class="mobile-logout">
        <button onclick="logout()">Logout</button>
    </div>
</body>
</html>
